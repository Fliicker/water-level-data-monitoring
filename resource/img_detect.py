import cv2 as cv
from datetime import datetime

mat_0 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_1 = [[255, 255, 255, 0, 255],
         [255, 255, 0, 0, 255],
         [255, 0, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255]]

mat_2 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255],
         [255, 255, 0, 255, 255],
         [255, 0, 255, 255, 255],
         [0, 0, 0, 0, 0]]

mat_3 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 0, 0, 255],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_4 = [[255, 255, 255, 0, 255],
         [255, 255, 0, 0, 255],
         [255, 255, 0, 0, 255],
         [255, 0, 255, 0, 255],
         [255, 0, 255, 0, 255],
         [0, 255, 255, 0, 255],
         [0, 0, 0, 0, 0],
         [255, 255, 255, 0, 255],
         [255, 255, 255, 0, 255]]

mat_5 = [[255, 0, 0, 0, 0],
         [255, 0, 255, 255, 255],
         [0, 255, 255, 255, 255],
         [0, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_6 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 255],
         [0, 255, 0, 0, 255],
         [0, 0, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_7 = [[0, 0, 0, 0, 0],
         [255, 255, 255, 255, 0],
         [255, 255, 255, 0, 255],
         [255, 255, 0, 255, 255],
         [255, 255, 0, 255, 255],
         [255, 255, 0, 255, 255],
         [255, 0, 255, 255, 255],
         [255, 0, 255, 255, 255],
         [255, 0, 255, 255, 255]]

mat_8 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_9 = [[255, 0, 0, 0, 255],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [0, 255, 255, 0, 0],
         [255, 0, 0, 255, 0],
         [255, 255, 255, 255, 0],
         [0, 255, 255, 255, 0],
         [255, 0, 0, 0, 255]]

mat_dot = [[255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 0, 255, 255]]

mat_colon = [[255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 0, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 0, 255, 255]]

mat_ = [[255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 0, 0, 0, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255],
         [255, 255, 255, 255, 255]]

mat_list = [
    {
        "mat": mat_0,
        "value": "0"
    },
    {
        "mat": mat_1,
        "value": "1"
    },
    {
        "mat": mat_2,
        "value": '2'
    },
    {
        "mat": mat_3,
        "value": '3'
    },
    {
        "mat": mat_4,
        "value": '4'
    },
    {
        "mat": mat_5,
        "value": '5'
    },
    {
        "mat": mat_6,
        "value": '6'
    },
    {
        "mat": mat_7,
        "value": '7'
    },
    {
        "mat": mat_8,
        "value": '8'
    },
    {
        "mat": mat_9,
        "value": '9'
    },
    {
        "mat": mat_dot,
        "value": '.'
    },
    {
        "mat": mat_colon,
        "value": ':'
    },
    {
        "mat": mat_,
        "value": '-'
    }

]


def check_matrix(img, row, col, mat):
    for i in range(9):
        for j in range(5):
            if img[row + i, col + j] != mat[i][j]:
                return False
    return True


def execute(path, station):
    img = cv.imread(path)
    img = cv.cvtColor(img, cv.COLOR_BGR2GRAY)
    thresh_img = cv.threshold(img, 240, 255, cv.THRESH_BINARY + cv.THRESH_OTSU)[1]

    result = []
    for i in range(thresh_img.shape[0] - 8):
        str_num = ''
        for j in range(170):
            for k in range(len(mat_list)):
                if check_matrix(thresh_img, i, j, mat_list[k]['mat']):
                    str_num += mat_list[k]['value']
        if str_num != '' and '0' <= str_num[0] <= '9':
            result.append(str_num)
    res = []
    for i in range(len(result)):
        temp_str = result[i]
        time = str(datetime.now().year) + "-" + temp_str[0:5] + " " + temp_str[5:10] + ":00"
        value = temp_str[10:]
        res.append({
            "station": station,
            "time": time,
            "value": value
        })
    return res



